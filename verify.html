<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Account - Spliitz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="styles.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Header with Logo -->
    <header class="w-full p-6 sm:p-8">
        <div class="text-3xl font-bold text-indigo-600 tracking-tighter cursor-pointer"
            onclick="window.location.href='/'">
            Spliitz
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex items-center justify-center p-4 sm:px-6 lg:px-8 -mt-20">
        <div class="w-full max-w-md glass-card rounded-2xl p-8 sm:p-10">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Verify your account</h2>
                <p class="mt-2 text-sm text-gray-600">
                    Enter the 6-digit code sent to <span id="verify-email-display"
                        class="font-medium text-indigo-600">your email</span>
                </p>
            </div>

            <form id="verify-form" class="space-y-6" onsubmit="event.preventDefault(); window.handleVerifyOtp(this);">
                <input type="hidden" name="email" id="verify-email-input">

                <div>
                    <label for="token" class="block text-sm font-medium text-gray-700 mb-2">Verification Code</label>
                    <div class="relative">
                        <input id="token" name="token" type="text" required
                            class="block w-full px-4 py-3 bg-white/50 border border-gray-300 rounded-xl text-center text-2xl tracking-[0.5em] font-bold text-gray-900 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric"
                            autocomplete="one-time-code">
                    </div>
                </div>

                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:-translate-y-0.5">
                    Verify Account
                </button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-sm text-gray-500 mb-4">
                    Didn't receive the code?
                    <span id="resend-timer" class="text-gray-400 font-medium ml-1">Resend in 60s</span>
                    <button id="resend-btn" onclick="window.handleResendOtp()"
                        class="hidden font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none transition-colors ml-1">Resend
                        Code</button>
                <p id="resend-msg" class="text-xs text-green-600 mt-2 hidden"></p>
                </p>
                <button onclick="window.history.back()"
                    class="text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors">
                    ‚Üê Go back
                </button>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm items-center justify-center z-50 hidden flex">
        <div class="spinner border-4 border-indigo-200 border-t-indigo-600 rounded-full w-12 h-12 animate-spin"></div>
    </div>

    <script>
        window.onerror = function (msg, url, line, col, error) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:1rem;z-index:9999;font-family:sans-serif;font-size:14px;';
            div.textContent = 'JS Error: ' + msg + ' at line ' + line;
            document.body.appendChild(div);
            return false;
        };
    </script>
    <script type="module">
        import { handleVerifyOtp, handleResendOtp, startResendTimer } from './js/handlers.js?v=4';

        window.handleVerifyOtp = handleVerifyOtp;
        window.handleResendOtp = handleResendOtp;

        // Auto-fill email from URL or LocalStorage
        const params = new URLSearchParams(window.location.search);
        let email = params.get('email');
        if (!email) {
            email = localStorage.getItem('spliitz_pending_email');
        }

        if (email) {
            document.getElementById('verify-email-display').textContent = email;
            document.getElementById('verify-email-input').value = email;
            // Start the timer on load
            if (startResendTimer) startResendTimer();
        } else {
            // If no email, redirect back to signin
            window.location.href = '/signin';
        }

        // Setup form listener safely
        const form = document.getElementById('verify-form');
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.handleVerifyOtp === 'function') {
                    window.handleVerifyOtp(e.target);
                } else {
                    alert('Error: Verification function not loaded yet. Please refresh.');
                }
            });
            // Remove the inline onsubmit to avoid conflict
            form.removeAttribute('onsubmit');
        }

        // Auto-focus input
        const tokenInput = document.getElementById('token');
        if (tokenInput) tokenInput.focus();
    </script>
</body>

</html>